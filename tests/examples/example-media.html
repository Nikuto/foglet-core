<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Foglet-core example</title>
  </head>

  <body>
    <p> Please: Open the console!</p>
    <p> Sender: <video id='peer1' width="320" height="240" controls autoplay></video> </p>
    <p> Receiver: <video id='peer2' width="320" height="240" controls></video></p>
    <p> Receiver: <video id='peer3' width="320" height="240" controls></video></p>
    <p> Receiver: <video id='peer4' width="320" height="240" controls></video></p>
  </body>

  <script src='/dist/foglet.bundle.js'></script>
  <script src='/jquery/jquery.min.js'></script>
  <script type='text/javascript'>
    console.log(foglet)
    const constraints = {
      video: true
    };
    localStorage.debug='foglet-core*'
    let app1, app2, app3, app4
    createApp().then((a) => {
      app1 = a
      app1.share()
      app1.connection().then(() => {
        createApp().then(b => {
          app2 = b
          app2.share()
          app2.connection().then(() => {
            createApp().then((c) => {
              app3 = c
              app3.share()
              app3.connection().then(() => {
                createApp().then((d) => {
                  app4 = d
                  app4.share()
                  app4.connection().then(() => {
                    console.log('Peers connected. Play now with them !')
                    teststream()
                  }).catch(e => {
                    console.log(e)
                  })
                })
              }).catch(e => {
                console.log(e)
              })
            })
          }).catch(e => {
            console.log(e)
          })
        }).catch(e => {
          console.log(e)
        })
      }).catch(e => {
        console.log(e)
      })
    }).catch(e => {
      console.log(e)
    })



    function createApp(id) {
      return new Promise((resolve, reject) => {
        $.get( "/ice",).then(data => {
          data.ice.splice(0, 1)
          data.ice.forEach(p => {
            if(p.url.indexOf('?transport=tcp') > -1){
                p.url = p.url.replace('?transport=tcp', '');
            } else if(p.url.indexOf('?transport=udp') > -1){
                p.url = p.url.replace('?transport=udp', '');
            }
            p.urls = String(p.url)
            delete p.url
          })
          console.log(data)
          const fog = new foglet.Foglet({
            id,
            verbose: true, // want some logs ? switch to false otherwise
            rps: {
              options : {
                delta: 10 * 1000,
                timeout: 1 * 1000,
                pendingTimeout: 10 * 1000,
                webrtc: {
                  trickle: true,
                  iceServers: data.ice
                },
                signaling: {
                  address: 'http://localhost:8000',
                  room: 'example-media',
                  origins: '*'
                }
              }
            }
          })
          fog.onUnicast((id, message) => {
            console.log(`${fog.id} received a unicasted message from ${id}: `, message)
          })
          fog.onBroadcast((id, message) => {
            console.log(`${fog.id} received a broadcasted message from ${id}: `, message)
          })
          resolve(fog)
        }).catch((e) => {
          console.error(e)
          reject(e)
        })
      })
    }



    function testunicast() {
      app1.sendUnicast(app2.id+'-I', 'Unicast: Hello world!')
    }

    function testbroadcast() {
      app1.sendBroadcast('Broadcast: Hello world!')
    }

    function teststream() {
      app2.overlay().communication.onMediaStream((id, mediaStream) => {
        console.log('Receive in the app the media stream: ', id, mediaStream)
        const video = document.getElementById('peer2');
        try {
          video.srcObject = mediaStream;
        } catch (error) {
          video.src = URL.createObjectURL(mediaStream);
        }
        video.play() // show the receiver
      })
      app3.overlay().communication.onMediaStream((id, mediaStream) => {
        console.log('Receive in the app the media stream: ', id, mediaStream)
        const video = document.getElementById('peer3');
        try {
          video.srcObject = mediaStream;
        } catch (error) {
          video.src = URL.createObjectURL(mediaStream);
        }
        video.play() // show the receiver
      })
      app4.overlay().communication.onMediaStream((id, mediaStream) => {
        console.log('Receive in the app the media stream: ', id, mediaStream)
        const video = document.getElementById('peer4');
        try {
          video.srcObject = mediaStream;
        } catch (error) {
          video.src = URL.createObjectURL(mediaStream);
        }
        video.play() // show the receiver
      })
      navigator.mediaDevices.getUserMedia(constraints).then((mediaStream) => {
        console.log(mediaStream)
        const video = document.getElementById('peer1');
        try {
          video.srcObject = mediaStream;
        } catch (error) {
          video.src = URL.createObjectURL(mediaStream);
        }
        video.play() // show the receiver
        app1.getNeighbours().forEach((neigh) => {
          console.log('Sending a media stream to %s', neigh)
          app1.overlay().communication.sendUnicastMediaStream(neigh, mediaStream)
        })
      }).catch(e => {
        console.error(e)
      })
    }

    function list_connections(fog) {
      let inviewPending, inviewLiving, inviewDying
      let outviewPending, outviewLiving, outviewDying
      let inview, outview
      inview = fog.overlay().network.rps.NI
      outview = fog.overlay().network.rps.NO
      inviewPending = inview.pending
      inviewLiving = inview.living
      inviewDying = inview.dying
      console.log('I-Pending size: ', inviewPending.size, inviewPending)
      console.log('I-Living size: ', inviewLiving.store.size, inviewLiving)
      console.log('I-Dying size: ', inviewDying.size, inviewDying)
      outviewPending = outview.pending
      outviewLiving = outview.living
      outviewDying = outview.dying
      console.log('O-Pending size: ', outviewPending.size, outviewPending)
      console.log('O-Living size: ', outviewLiving.store.size, outviewLiving)
      console.log('I-Dying size: ', outviewDying.size, outviewDying)
    }
  </script>
</html>
